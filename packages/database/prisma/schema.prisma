// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../generated"
}

datasource db {
  provider     = "postgresql"
  relationMode = "prisma"
}

// User status for insurance sync and death trigger
enum UserStatus {
  ACTIVE // Normal user
  INACTIVE // Disabled by insurance (cannot log in)
  DECEASED // Death triggered (data locked)
}

// User profile extending Clerk user data
model UserProfile {
  id                 String     @id @default(cuid())
  clerkUserId        String     @unique
  fullName           String
  dateOfBirth        DateTime?
  email              String
  phone              String?
  countryOfResidence String?
  onboardingComplete Boolean    @default(false)
  status             UserStatus @default(ACTIVE)
  deceasedAt         DateTime? // When death was triggered
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  trustedContacts TrustedContact[]
  digitalAccounts DigitalAccount[]
  documents       Document[]
  mediaFolders    MediaFolder[]
  mediaItems      MediaItem[]

  @@index([clerkUserId])
  @@index([email])
}

// Trusted contacts who can access user's digital legacy
model TrustedContact {
  id           String           @id @default(cuid())
  userId       String
  user         UserProfile      @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  email        String?
  phone        String?
  relationship RelationshipType
  role         ContactRole
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  documentAccess     DocumentAccess[]
  mediaFolderAccess  MediaFolderAccess[]
  accountAccess      AccountAccess[]
  legacyAccessTokens LegacyAccessToken[]

  @@index([userId])
}

enum RelationshipType {
  FAMILY
  FRIEND
  COWORKER
  LEGAL
  OTHER
}

enum ContactRole {
  EXECUTOR
  RECIPIENT
}

// Digital accounts across various platforms
model DigitalAccount {
  id            String          @id @default(cuid())
  userId        String
  user          UserProfile     @relation(fields: [userId], references: [id], onDelete: Cascade)
  category      AccountCategory
  platformName  String
  platformIcon  String?
  username      String?
  email         String?
  actionOnDeath ActionOnDeath
  transferToId  String?
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  accessList AccountAccess[]

  @@index([userId])
  @@index([category])
}

enum AccountCategory {
  SOCIAL_MEDIA
  EMAIL_COMMUNICATION
  FINANCIAL
  CRYPTO
  SUBSCRIPTIONS
  OTHER
}

enum ActionOnDeath {
  DELETE
  TRANSFER
  MEMORIALIZE
}

// Documents uploaded by user
model Document {
  id          String      @id @default(cuid())
  userId      String
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  fileUrl     String
  fileType    String
  fileSize    Int
  isWill      Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  accessList DocumentAccess[]

  @@index([userId])
  @@index([isWill])
}

// Folders for organizing media
model MediaFolder {
  id          String      @id @default(cuid())
  userId      String
  user        UserProfile @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items      MediaItem[]
  accessList MediaFolderAccess[]

  @@index([userId])
}

// Individual media items (photos/videos)
model MediaItem {
  id        String       @id @default(cuid())
  userId    String
  user      UserProfile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  folderId  String?
  folder    MediaFolder? @relation(fields: [folderId], references: [id], onDelete: SetNull)
  name      String
  fileUrl   String
  fileType  String
  fileSize  Int
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@index([userId])
  @@index([folderId])
}

// Access control: Documents
model DocumentAccess {
  id         String         @id @default(cuid())
  documentId String
  document   Document       @relation(fields: [documentId], references: [id], onDelete: Cascade)
  contactId  String
  contact    TrustedContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([documentId, contactId])
  @@index([documentId])
  @@index([contactId])
}

// Access control: Media folders
model MediaFolderAccess {
  id        String         @id @default(cuid())
  folderId  String
  folder    MediaFolder    @relation(fields: [folderId], references: [id], onDelete: Cascade)
  contactId String
  contact   TrustedContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([folderId, contactId])
  @@index([folderId])
  @@index([contactId])
}

// Access control: Digital accounts
model AccountAccess {
  id        String         @id @default(cuid())
  accountId String
  account   DigitalAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  contactId String
  contact   TrustedContact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([accountId, contactId])
  @@index([accountId])
  @@index([contactId])
}

// Pending invitations from insurance company
model PendingInvitation {
  id           String    @id @default(cuid())
  email        String
  name         String?
  insuranceRef String? // Reference ID from insurance company
  invitedAt    DateTime  @default(now())
  acceptedAt   DateTime?
  userId       String? // Linked when user completes signup

  @@unique([email])
  @@index([insuranceRef])
}

// Legacy access tokens for trusted contacts to view deceased user's data
model LegacyAccessToken {
  id         String         @id @default(cuid())
  contactId  String
  contact    TrustedContact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  token      String         @unique
  userId     String // The deceased user's profile ID
  createdAt  DateTime       @default(now())
  expiresAt  DateTime? // Optional expiration
  lastUsedAt DateTime?

  @@index([token])
  @@index([contactId])
  @@index([userId])
}
